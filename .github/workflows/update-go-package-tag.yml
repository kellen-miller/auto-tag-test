name: go package tag
on:
  push:
    branches:
      - main
      - master
    paths:
      - 'clients.go'
permissions:
  contents: write
jobs:
    update-go-package-tag:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v3
            - name: Update Tag
              uses: actions/github-script@v6
              with:
                script: |
                  const fs = require('fs')
                  
                  const response = await github.rest.repos.listTags({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pattern: 'v[0-9]\+\.[0-9]\+\.[0-9]\+'
                  })
  
                  const file = fs.readFileSync('clients.go', 'utf8')
                  const version = file.match(/v\d+\.\d+\.\d+/)
  
                  response.data.forEach(tag => { 
                    if (tag.name === version) {
                      console.log('Tag ' + tag.name + ' already exists')
                      return
                    }
                  })
                  
                  try {
                    github.rest.git.createRef({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      ref: `refs/tags/${version}`,
                      sha: context.sha
                    })
                  } catch (error) {
                    console.log(error)
                  }
                  
                  console.log("Tag " + version + " created")