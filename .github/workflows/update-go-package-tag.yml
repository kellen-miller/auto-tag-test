name: go package tag
on:
  push:
    branches:
      - main
      - master
    paths:
      - 'clients.go'
permissions:
  contents: write
jobs:
    update-go-package-tag:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v3
            - name: Update Tag
              uses: actions/github-script@v6
              with:
                script: |
                  const tags = await github.rest.repos.listTags({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pattern: 'v[0-9]\+\.[0-9]\+\.[0-9]\+'
                  })
  
                  const file = fs.readFileSync('clients.go', 'utf8')
                  const version = file.match(/v\d+\.\d+\.\d+/)
  
                  for (const tag of tags) {
                    console.log(tag.name)
                    if (tag.name === version) {
                      console.log('Tag ' + tag.name + ' already exists')
                      return
                    }
                  }
                  
                  console.log("PCGV: " + process.env.PLATFORM_CLIENT_GO_VERSION)
                  github.rest.git.createRef({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    ref: `refs/tags/${process.env.PLATFORM_CLIENT_GO_VERSION}`,
                    sha: context.sha
                  })
#
#                  const script = require('script/update-tag.js')
#                  await script({github, context})
#            - name: Get the version
#              id: get_platform_client_go_version
#              run: |
#                echo "PLATFORM_CLIENT_GO_VERSION=$(grep -o 'v[0-9]\+\.[0-9]\+\.[0-9]\+' clients.go)" >> $GITHUB_OUTPUT
#            - name: Update go package tag
#              uses: actions/github-script@v6
#              env:
#                PLATFORM_CLIENT_GO_VERSION: ${{ steps.get_platform_client_go_version.outputs.PLATFORM_CLIENT_GO_VERSION }}
#              with:
#                script: |
#                  github.rest.git.createRef({
#                    owner: context.repo.owner,
#                    repo: context.repo.repo,
#                    ref: `refs/tags/${process.env.PLATFORM_CLIENT_GO_VERSION}`,
#                    sha: context.sha
#                  })